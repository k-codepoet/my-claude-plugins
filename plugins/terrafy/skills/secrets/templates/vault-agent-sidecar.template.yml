# =============================================================================
# Vault Agent Sidecar Template — Docker Compose 서비스용
# =============================================================================
# 사용법:
#   1. 플레이스홀더를 실제 값으로 치환
#   2. 메인 서비스의 docker-compose.yml에 vault-agent 서비스 추가
#   3. Portainer Stack Variables에 VAULT_ROLE_ID, VAULT_SECRET_ID 설정
#
# 플레이스홀더:
#   {SERVICE}        — 서비스 이름 (예: grafana)
#   {VAULT_VERSION}  — Vault 이미지 버전 (예: 1.15)
#   {VAULT_URL}      — Vault 서버 URL (docs/services/vault.md 참조)
#   {SECRET_PATH}    — Vault 시크릿 경로 (예: secret/services/grafana)
#   {ENV_KEYS}       — 렌더링할 환경변수 키 목록
#   {IMAGE}          — 메인 서비스 이미지
#   {CMD}            — 메인 서비스 실행 명령
#   {NETWORK}        — Docker 네트워크 이름 (디바이스별 상이, CLAUDE.md 참조)
# =============================================================================

services:
  # --- Vault Agent: 시크릿 렌더링 후 종료 ---
  vault-agent:
    image: hashicorp/vault:{VAULT_VERSION}
    restart: "no"
    environment:
      - VAULT_ADDR={VAULT_URL}
      - VAULT_ROLE_ID=${VAULT_ROLE_ID}
      - VAULT_SECRET_ID=${VAULT_SECRET_ID}
    entrypoint:
      - sh
      - -c
      - |
        # 1. AppRole credentials 파일 생성
        mkdir -p /secrets
        echo "$VAULT_ROLE_ID" > /secrets/role-id
        echo "$VAULT_SECRET_ID" > /secrets/secret-id

        # 2. Vault Agent config 생성
        cat > /tmp/agent.hcl <<'AGENT_EOF'
        auto_auth {
          method "approle" {
            config = {
              role_id_file_path   = "/secrets/role-id"
              secret_id_file_path = "/secrets/secret-id"
              remove_secret_id_file_after_reading = false
            }
          }
          sink "file" {
            config = { path = "/secrets/vault-token" }
          }
        }

        template {
          contents = <<TMPL
        {{- with secret "{SECRET_PATH}" -}}
        {ENV_KEYS}
        {{- end -}}
        TMPL
          destination = "/secrets/{SERVICE}.env"
        }

        vault { address = "${VAULT_ADDR}" }
        exit_after_auth = true
        AGENT_EOF

        # 3. Agent 실행
        vault agent -config=/tmp/agent.hcl
    volumes:
      - secrets:/secrets

  # --- 메인 서비스: .env 로드 후 실행 ---
  {SERVICE}:
    image: {IMAGE}
    restart: unless-stopped
    entrypoint:
      - sh
      - -c
      - "export $$(cat /secrets/{SERVICE}.env | xargs) && exec {CMD}"
    depends_on:
      vault-agent:
        condition: service_completed_successfully
    volumes:
      - secrets:/secrets
    networks:
      - {NETWORK}

volumes:
  secrets:

networks:
  {NETWORK}:
    external: true
