# GitLab CI Template: Multiplatform Build + Deploy
# 앱 서비스 repo에서 Docker 빌드 + Portainer GitOps 배포 표준 파이프라인
#
# Placeholders:
#   {REGISTRY_DOMAIN}   - 컨테이너 레지스트리 도메인
#   {GROUP}              - GitLab 그룹명
#   {PROJECT}            - GitLab 프로젝트명
#   {IMAGE}              - 이미지 이름
#   {BUILD_RUNNER_TAG}   - 빌드 Runner tag (arm64 native)
#   {GIT_DOMAIN}         - GitLab 도메인
#
# 사용법:
#   1. placeholders를 실제 값으로 교체
#   2. 앱 repo 루트에 .gitlab-ci.yml로 저장
#   3. Dockerfile + docker-compose.yml 준비

stages:
  - build
  - deploy

variables:
  DOCKER_TLS_CERTDIR: "/certs"
  REGISTRY_URL: "{REGISTRY_DOMAIN}"
  IMAGE_NAME: "${REGISTRY_URL}/{GROUP}/{PROJECT}/{IMAGE}"

# ============================================================
# Build Stage - Multiplatform Docker Image
# ============================================================
build:
  stage: build
  tags:
    - "{BUILD_RUNNER_TAG}"    # arm64 네이티브 Runner
  image: docker:latest
  services:
    - name: docker:dind
      alias: docker
  variables:
    DOCKER_DRIVER: overlay2
  before_script:
    # CI_REGISTRY_USER / CI_REGISTRY_PASSWORD는 GitLab이 자동 주입
    - echo "$CI_REGISTRY_PASSWORD" | docker login $REGISTRY_URL -u $CI_REGISTRY_USER --password-stdin
    # buildx builder 생성
    - docker buildx create --use --name multiarch --driver docker-container
    - docker buildx inspect --bootstrap
  script:
    - |
      docker buildx build \
        --platform linux/amd64,linux/arm64 \
        -t ${IMAGE_NAME}:${CI_COMMIT_TAG} \
        -t ${IMAGE_NAME}:latest \
        --push .
  rules:
    - if: '$CI_COMMIT_TAG =~ /^v.+/'    # v* 태그에서만 실행

# ============================================================
# Deploy Stage - Update docker-compose.yml image tag
# ============================================================
deploy:
  stage: deploy
  # tags 미지정 → 경량 작업, 아무 Runner에서 실행
  image: alpine:latest
  before_script:
    - apk add --no-cache git
    - git config user.name "GitLab CI"
    - git config user.email "ci@{GIT_DOMAIN}"
    - git remote set-url origin "https://gitlab-ci-token:${CI_JOB_TOKEN}@{GIT_DOMAIN}/${CI_PROJECT_PATH}.git"
  script:
    # docker-compose.yml 이미지 태그 업데이트
    - sed -i "s|image:.*${IMAGE_NAME}:.*|image: ${IMAGE_NAME}:${CI_COMMIT_TAG}|" docker-compose.yml
    - git add docker-compose.yml
    - git commit -m "deploy: update image tag to ${CI_COMMIT_TAG} [skip ci]"
    - git push origin HEAD:main
  rules:
    - if: '$CI_COMMIT_TAG =~ /^v.+/'    # v* 태그에서만 실행

# ============================================================
# Notes:
# - build: arm64 Runner에서 buildx 멀티플랫폼 빌드
# - deploy: [skip ci]로 무한 루프 방지
# - Portainer GitOps polling(5분)이 compose 변경 감지 → 자동 재배포
# - ci_push_repository_for_job_token_allowed 설정 필요
# ============================================================
